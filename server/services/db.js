/**
 * Database Service
 * Handles interaction with Vercel Postgres
 */

import { sql } from '@vercel/postgres';

/**
 * Log chat interaction to database
 * @param {string} userMessage - The message sent by the user
 * @param {string} aiResponse - The response generated by AI
 * @param {Object} metadata - Additional metadata (IP, UA, etc.)
 */
export async function logChat(userMessage, aiResponse, metadata = {}) {
    try {
        // Check if DB is configured
        if (!process.env.POSTGRES_URL) {
            console.warn('POSTGRES_URL not set, skipping chat logging');
            return;
        }

        const { ip, userAgent, ...otherMeta } = metadata;

        await sql`
            INSERT INTO chat_logs (user_message, ai_response, ip_address, user_agent, metadata)
            VALUES (${userMessage}, ${aiResponse}, ${ip}, ${userAgent}, ${JSON.stringify(otherMeta)});
        `;

        console.log('Chat logged to database successfully');
    } catch (error) {
        // Log error but don't fail the request
        console.error('Failed to log chat to database:', error);
    }
}

/**
 * Test database connection
 */
export async function checkDatabaseConnection() {
    try {
        if (!process.env.POSTGRES_URL) {
            return { success: false, error: 'Environment variable POSTGRES_URL is not set' };
        }
        const result = await sql`SELECT NOW() as now`;
        return { success: true, timestamp: result.rows[0].now };
    } catch (error) {
        return { success: false, error: error.message };
    }
}
